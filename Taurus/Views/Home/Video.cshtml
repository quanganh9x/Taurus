@{
    Layout = null;
    dynamic u = null;
    if (User.IsInRole("Doctor"))
    {
        u = ViewData["User"] as Doctor;
    } else
    {
        u = ViewData["User"] as Customer;
    }
    Room r = ViewData["Room"] as Room;
}

<!-- Demo version: 2018.12.11 -->

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Room</title>


    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="~/lib/emojionearea/emojionearea.min.css">
    <link rel="stylesheet" href="~/css/getHTMLMediaElement.css">


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Swiper CSS -->
    <link rel="stylesheet" href="~/css/swiper.min.css">

    <!-- Styles -->
    <link rel="stylesheet" href="~/css/style.css">

    <script src='~/lib/jquery/dist/jquery.min.js'></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src='~/js/jquery.collapsible.min.js'></script>
    <script src='~/js/swiper.min.js'></script>
    <script src='~/js/jquery.countdown.min.js'></script>
    <script src='~/js/circle-progress.min.js'></script>
    <script src='~/js/jquery.countTo.min.js'></script>
    <script src='~/js/jquery.barfiller.js'></script>
    <script src='~/js/custom.js'></script>

    <script src="~/lib/webrtc-adapter/adapter.min.js"></script>
    <script src="~/lib/rtcmulticonnection/dist/RTCMultiConnection.min.js"></script>
    <script src="~/lib/signalr/dist/browser/signalr.min.js"></script>
    <script src="~/lib/socket.io/socket.io.js"></script>
    <script src="~/js/FileBufferReader.min.js"></script>

    <script src="~/js/SignalRHandler.js"></script>

    <script src="~/js/getHTMLMediaElement.js"></script>
    <script src="~/lib/emojionearea/emojionearea.min.js"></script>
</head>
<body>
    <style>
        html, body {
            height: 100%;
        }

        .container-fluid, .row {
            height: 100%;
            padding: 0;
        }

        #btn-comments {
            color: red;
            margin-top: 5px;
            font-size: 24px;
            text-shadow: 1px 1px white;
        }

        #txt-chat-message {
            width: 100%;
            resize: vertical;
            margin: 5px;
            margin-right: 0;
            min-height: 30px;
        }

        #btn-chat-message {
            margin: 5px;
        }

        #conversation-panel {
            margin-bottom: 20px;
            text-align: left;
            width: 100%;
            height: 85%;
            overflow: auto;
            border-top: 1px solid #E5E5E5;
        }

            #conversation-panel .message {
                border-bottom: 1px solid #E5E5E5;
                padding: 5px 10px;
            }

                #conversation-panel .message img, #conversation-panel .message video, #conversation-panel .message iframe {
                    max-width: 100%;
                    max-height: 100px;
                }


        #btn-attach-file {
            width: 25px;
            vertical-align: middle;
            cursor: pointer;
        }

    </style>

    <div class="container-fluid">

        <div class="row">

            <div class="col-12" style="height: 100%">

                    <div id="conversation-panel"></div>
                    <div id="key-press" style="text-align: right; display: none; font-size: 11px;">
                        <span style="vertical-align: middle;"></span>
                        <img src="data:image/png;base64,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" style="height: 12px; vertical-align: middle;">
                    </div>
                    <textarea id="txt-chat-message"></textarea>
                    <button class="btn btn-primary" id="btn-chat-message" disabled>Send</button>
                    <img id="btn-attach-file" src="data:image/png;base64,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" title="Attach a File">

            </div>

            <div class="col-12" id="videos-container" style="height: 100%; align-content: center;">
            </div>

        </div>
    </div>

    <script>

        window.adapter = true;

        (function () {
            var params = {},
                r = /([^&=]+)=?([^&]*)/g;

            function d(s) {
                return decodeURIComponent(s.replace(/\+/g, ' '));
            }
            var match, search = window.location.search;
            while (match = r.exec(search.substring(1)))
                params[d(match[1])] = d(match[2]);
            window.params = params;
        })();

        var connection = new RTCMultiConnection();

        //connection.setCustomSocketHandler(SignalRHandler);

        //connection.socketURL = "http://localhost:9001/";
        connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';

        connection.session = {
            audio: true,
            video: true,
            data: true
        };
        connection.sdpConstraints.mandatory = {
            OfferToReceiveAudio: true,
            OfferToReceiveVideo: true
        };

        connection.userid = "@u.User.FullName";
        connection.extra.userFullName = "@u.User.FullName";

        connection.socketMessageEvent = "@r.Id";

        connection.autoCloseEntireSession = true;
        connection.maxParticipantsAllowed = 2;
        connection.enableFileSharing = true;

        connection.onUserStatusChanged = function (event, bonus) {
            var names = [];
            connection.getAllParticipants().forEach(function (pid) {
                names.push(getFullName(pid));
                if (bonus === "join") appendChatMessage("User: <b>" + getFullName(pid) + "</b> joined!");
                else if (bonus === "out") appendChatMessage("User: <b>" + getFullName(pid) + "</b> exited!");
            });

            if (!names.length) {
                names = ['Self'];
            } else {
                names = [connection.extra.userFullName || 'Self'].concat(names);
            }


        };

        connection.onopen = function (event) {
            connection.onUserStatusChanged(event);

            document.getElementById('btn-chat-message').disabled = false;
            document.getElementById('btn-attach-file').style.display = 'inline-block';
        };

        connection.onclose = connection.onerror = connection.onleave = function (event) {
            connection.onUserStatusChanged(event);
        };

        connection.onmessage = function (event) {
            if (event.data.showMainVideo) {
                $('#videos-container').show();
                return;
            }

            if (event.data.hideMainVideo) {
                $('#videos-container').hide();
                return;
            }

            if (event.data.typing === true) {
                $('#key-press').show().find('span').html(event.extra.userFullName + ' is typing');
                return;
            }

            if (event.data.typing === false) {
                $('#key-press').hide().find('span').html('');
                return;
            }

            if (event.data.chatMessage) {
                appendChatMessage(event);
                return;
            }
        };

        connection.videosContainer = document.getElementById("videos-container");
        connection.onstream = function (event) {
            event.mediaElement.removeAttribute('src');
            event.mediaElement.removeAttribute('srcObject');

            var video = document.createElement('video');
            video.controls = false;
            video.setAttribute('data-streamid', event.streamid);
            if (event.type === 'local') {
                video.muted = true;
                video.volume = 0;
            }
            video.srcObject = event.stream;

            var mediaElement = getHTMLMediaElement(video, {
                title: event.userid,
                buttons: ['full-screen'],
                width: "50%",
                showOnMouseEnter: false
            });

            connection.videosContainer.appendChild(mediaElement);

            setTimeout(function () {
                mediaElement.media.play();
            }, 5000);

            mediaElement.id = event.streamid;

            connection.onUserStatusChanged(event, "join");
        };

        connection.onstreamended = function (event) {
            if (!connection.extra.roowOwner) location.href = "/";
            var video = document.getElementById(event.streamid);
            video.parentNode.removeChild(video);

            connection.onUserStatusChanged(event, "out");
            return;
        };

        var conversationPanel = document.getElementById('conversation-panel');

        function appendChatMessage(event) {
            var div = document.createElement('div');

            div.className = 'message';

            if (event.data) {
                div.innerHTML = '<b>' + (event.extra.userFullName || event.userid) + ':</b> ' + event.data.chatMessage;

                
            } else {
                div.innerHTML = '<b>You:</b> ' + event;
                div.style.background = '#cbffcb';
            }

            conversationPanel.appendChild(div);

            conversationPanel.scrollTop = conversationPanel.clientHeight;
            conversationPanel.scrollTop = conversationPanel.scrollHeight - conversationPanel.scrollTop;
        }

        var keyPressTimer;
        var numberOfKeys = 0;
        $('#txt-chat-message').emojioneArea({
            pickerPosition: "top",
            filtersPosition: "bottom",
            tones: false,
            autocomplete: true,
            inline: true,
            hidePickerOnBlur: true,
            events: {
                focus: function () {
                    $('.emojionearea-category').unbind('click').bind('click', function () {
                        $('.emojionearea-button-close').click();
                    });
                },
                keyup: function (e) {
                    var chatMessage = $('.emojionearea-editor').html();
                    if (!chatMessage || !chatMessage.replace(/ /g, '').length) {
                        connection.send({
                            typing: false
                        });
                    }


                    clearTimeout(keyPressTimer);
                    numberOfKeys++;

                    if (numberOfKeys % 3 === 0) {
                        connection.send({
                            typing: true
                        });
                    }

                    keyPressTimer = setTimeout(function () {
                        connection.send({
                            typing: false
                        });
                    }, 1200);
                },
                blur: function () {
                    // $('#btn-chat-message').click();
                    connection.send({
                        typing: false
                    });
                }
            }
        });

        window.onkeyup = function (e) {
            var code = e.keyCode || e.which;
            if (code == 13) {
                $('#btn-chat-message').click();
            }
        };

        document.getElementById('btn-chat-message').onclick = function () {
            if ($('#btn-chat-message').attr("disabled")) return;
            var chatMessage = $('.emojionearea-editor').html();
            $('.emojionearea-editor').html('');

            if (!chatMessage || !chatMessage.replace(/ /g, '').length) return;


            appendChatMessage(chatMessage);

            connection.send({
                chatMessage: chatMessage
            });

            connection.send({
                typing: false
            });
        };

        var recentFile;
        document.getElementById('btn-attach-file').onclick = function () {
            var file = new FileSelector();
            file.selectSingleFile(function (file) {
                recentFile = file;

                if (connection.getAllParticipants().length >= 1) {
                    recentFile.userIndex = 0;
                    connection.send(file, connection.getAllParticipants()[recentFile.userIndex]);
                }
            });
        };

        function getFileHTML(file) {
            var url = file.url || URL.createObjectURL(file);
            var attachment = '<a href="' + url + '" target="_blank" download="' + file.name + '">Download: <b>' + file.name + '</b></a>';
            return attachment;
        }

        function getFullName(userid) {
            var _userFullName = userid;
            if (connection.peers[userid] && connection.peers[userid].extra.userFullName) {
                _userFullName = connection.peers[userid].extra.userFullName;
            }
            return _userFullName;
        }

        connection.onFileEnd = function (file) {
            var html = getFileHTML(file);
            var div = progressHelper[file.uuid].div;

            if (file.userid === connection.userid) {
                div.innerHTML = '<b>You: </b><br>' + html;
                div.style.background = '#cbffcb';

                if (recentFile) {
                    recentFile.userIndex++;
                    var nextUserId = connection.getAllParticipants()[recentFile.userIndex];
                    if (nextUserId) {
                        connection.send(recentFile, nextUserId);
                    }
                    else {
                        recentFile = null;
                    }
                }
                else {
                    recentFile = null;
                }
            } else {
                div.innerHTML = '<b>' + getFullName(file.userid) + ':</b><br>' + html;
            }
        };

        // to make sure file-saver dialog is not invoked.
        connection.autoSaveToDisk = false;

        var progressHelper = {};

        connection.onFileProgress = function (chunk, uuid) {
            var helper = progressHelper[chunk.uuid];
            helper.progress.value = chunk.currentPosition || chunk.maxChunks || helper.progress.max;
            updateLabel(helper.progress, helper.label);
        };

        connection.onFileStart = function (file) {
            var div = document.createElement('div');
            div.className = 'message';

            if (file.userid === connection.userid) {
                var userFullName = file.remoteUserId;
                if (connection.peersBackup[file.remoteUserId]) {
                    userFullName = connection.peersBackup[file.remoteUserId].extra.userFullName;
                }

                div.innerHTML = '<b>You (to: ' + userFullName + '):</b><br><label>0%</label> <progress></progress>';
                div.style.background = '#cbffcb';
            } else {
                div.innerHTML = '<b>' + getFullName(file.userid) + ':</b><br><label>0%</label> <progress></progress>';
            }

            div.title = file.name;
            conversationPanel.appendChild(div);
            progressHelper[file.uuid] = {
                div: div,
                progress: div.querySelector('progress'),
                label: div.querySelector('label')
            };
            progressHelper[file.uuid].progress.max = file.maxChunks;

            conversationPanel.scrollTop = conversationPanel.clientHeight;
            conversationPanel.scrollTop = conversationPanel.scrollHeight - conversationPanel.scrollTop;
        };

        function updateLabel(progress, label) {
            if (progress.position == -1) return;
            var position = +progress.position.toFixed(2).split('.')[1] || 100;
            label.innerHTML = position + '%';
        }





        function addStreamStopListener(stream, callback) {
            stream.addEventListener('ended', function () {
                callback();
                callback = function () { };
            }, false);

            stream.addEventListener('inactive', function () {
                callback();
                callback = function () { };
            }, false);

            stream.getTracks().forEach(function (track) {
                track.addEventListener('ended', function () {
                    callback();
                    callback = function () { };
                }, false);

                track.addEventListener('inactive', function () {
                    callback();
                    callback = function () { };
                }, false);
            });
        }

        

        connection.DetectRTC.load(function () {
            if (connection.DetectRTC.isWebRTCSupported === false || connection.DetectRTC.hasMicrophone === false || connection.DetectRTC.hasWebcam === false || connection.DetectRTC.hasSpeakers === false) {
                alert('You dont fulfill requirements or your browser doesnt support WebRTC');
                window.location.href = "/";
            }

            connection.checkPresence(connection.socketMessageEvent, function (isRoomExist, roomid, error) {
                if (isRoomExist === true) {
                    connection.join(roomid);

                    $.post("@Url.Action("CreateSession", "Session")", { RoomId: "@r.Id"} )
                        .done(function (data) {
                            console.log(data);
                        })
                        .fail(function (data) {
                            console.log(data);
                        });
                } else {
                    connection.extra.roowOwner = true;
                    connection.open(roomid);


                    $.post("@Url.Action("ActiveRoom", "Room")", { id: "@r.Id"} )
                        .done(function (data) {
                            console.log(data);
                        })
                        .fail(function (data) {
                            console.log(data);
                        });
                }
            });
        });

        window.addEventListener('beforeunload', function () {
            if (connection.extra.roowOwner == true) {
                $.post("@Url.Action("EndRoom", "Room")", { roomId: "@r.Id" })
                    .done(function (data) {
                        console.log(data);
                    })
                    .fail(function (data) {
                        console.log(data);
                    });
            } else {
                @*$.post("@Url.Action("EndSession", "Session")" )
                    .done(function (data) {
                            console.log(data);
                        })
                        .fail(function (data) {
                            console.log(data);
                    });*@

                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("EndSession", "Session")',
                    async: false,                   
                });
            }
        })
    </script>
</body>
</html>
